<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Speciaal Transport Zwolle B.V. - Begeleidingenrapport</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="print.css" media="print">
  <style>
    .rapport-tabel {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .rapport-tabel th,
    .rapport-tabel td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      text-align: left;
    }
    .rapport-tabel th {
      background-color: #f2f2f2;
      font-weight: bold;
    }
    .rapport-tabel tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .rapport-tabel tr:hover {
      background-color: #eef;
    }
    .rapport-tabel button {
      padding: 4px 8px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .rapport-tabel button:hover {
      background-color: #0056b3;
    }
    .rapport-tabel button.verwijder {
      background-color: #dc3545;
    }
    .rapport-tabel button.verwijder:hover {
      background-color: #a92828;
    }
  </style>
</head>
<body>

<header>
  <img src="logo.png" alt="Speciaal Transport Zwolle B.V." class="logo">
  <h1>BEGELEIDINGENRAPPORT</h1>
</header>

<nav class="top-menu">
  <button onclick="window.location.href='index.html'">üè† HOME</button>
  <button onclick="window.location.href='vergunningen.html'">INBOEKEN VERGUNNINGEN</button>
  <button onclick="window.location.href='ontheffingenrapport.html'">ONTHEFFINGEN RAPPORT</button>
  <button onclick="window.location.href='begeleidingenrapport.html'">BEGELEIDINGEN RAPPORT</button>
  <button onclick="window.location.href='transportbegeleiding.html'">AANVRAAG TRANSPORTBEGELEIDING</button>
  <button id="admin-gebruikersbeheer" onclick="window.location.href='gebruikersbeheer.html'" style="display:none;">GEBRUIKERSBEHEER</button>
  <button id="admin-statistieken" onclick="window.location.href='statistieken.html'" style="display:none;">STATISTIEKEN</button>
</nav>

<main class="card">
  <h2>BEGELEIDINGEN RAPPORT</h2>

  <div class="form-grid">
    <label>Referentienummer:
      <div class="split-input">
        <span class="prefix">2025.</span>
        <input type="text" id="referentienummer" maxlength="4">
      </div>
    </label>
    <label>Behandelaar:
      <select id="behandelaar">
        <option value="">--- Maak keuze ---</option>
        <option value="Ren√©">Ren√©</option>
        <option value="Anke">Anke</option>
        <option value="Sia">Sia</option>
        <option value="Martijn">Martijn</option>
      </select>
    </label>
<label>Eindcontrole:
  <select id="eindcontrole">
    <option value="">--- Maak keuze ---</option>
    <option value="Ren√©">Ren√©</option>
    <option value="Anke">Anke</option>
    <option value="Sia">Sia</option>
    <option value="Martijn">Martijn</option>
  </select>
</label>
  </div>

  <div class="form-grid-three">
    <label>Opdrachtgever:
      <input type="text" id="opdrachtgever">
    </label>
    <label>Vervoerder:
      <input type="text" id="vervoerder">
    </label>
    <label>Referentie klant:
      <input type="text" id="referentie_klant">
    </label>
  </div>

  <div class="form-grid-single">
    <label>Omschrijving:
      <textarea id="omschrijving"></textarea>
    </label>
  </div>

  <div class="form-grid-single">
    <label>Opmerkingen t.a.v. facturatie:
      <textarea id="opmerkingen_facturatie"></textarea>
    </label>
  </div>

  <h3>Details per regel</h3>
  <div class="form-grid-seven">
    <div>
      <label>Begeleidingsfirma:</label>
      <input type="text" value="Bemiddeling STZ"><input><input><input><input><input><input><input>
    </div>
    <div>
      <label>Transportdatum:</label>
      <input type="date"><input type="date"><input type="date"><input type="date">
      <input type="date"><input type="date"><input type="date"><input type="date">
    </div>
    <div>
      <label>Van:</label>
      <input><input><input><input><input><input><input><input>
    </div>
    <div>
      <label>Naar:</label>
      <input><input><input><input><input><input><input><input>
    </div>
    <div>
      <label>Uren:</label>
      <input type="number"><input type="number"><input type="number"><input type="number">
      <input type="number"><input type="number"><input type="number"><input type="number">
    </div>
    <div>
      <label>Inkoopprijs (‚Ç¨):</label>
      <input type="text" data-type="inkoop"><input type="text" data-type="inkoop">
      <input type="text" data-type="inkoop"><input type="text" data-type="inkoop">
      <input type="text" data-type="inkoop"><input type="text" data-type="inkoop">
      <input type="text" data-type="inkoop"><input type="text" data-type="inkoop">
    </div>
    <div>
      <label>Verkoopprijs (‚Ç¨):</label>
      <input type="text" data-type="verkoop"><input type="text" data-type="verkoop">
      <input type="text" data-type="verkoop"><input type="text" data-type="verkoop">
      <input type="text" data-type="verkoop"><input type="text" data-type="verkoop">
      <input type="text" data-type="verkoop"><input type="text" data-type="verkoop">
    </div>
  </div>

  <div class="form-grid-three">
    <label>Inkoopprijs totaal (‚Ç¨):
      <input type="text" id="inkoop_totaal" readonly>
    </label>
    <label>Verkoopprijs totaal (‚Ç¨):
      <input type="text" id="verkoop_totaal" readonly>
    </label>
    <label>Marge (‚Ç¨):
      <input type="text" id="marge" readonly>
    </label>
  </div>
  <button onclick="opslaanRapport()" class="primary-btn">üìÅ RAPPORT OPSLAAN</button>
  <button onclick="genereerPDF()" class="primary-btn">üì• DOWNLOAD ALS PDF</button>

<h3 style="margin-top: 30px;">Opgeslagen Rapporten</h3>
  <table id="rapportTabel" class="rapport-tabel">
    <thead>
      <tr>
        <th>Referentienummer</th>
        <th>Opdrachtgever</th>
        <th>Behandelaar</th>
        <th>Actie</th>
      </tr>
    </thead>
    <tbody id="rapportTabelBody"></tbody>
  </table>
</main>

<script>
function formatEuro(value) {
  const number = parseFloat(value);
  if (isNaN(number)) return '';
  return number.toFixed(2).replace('.', ',');
}

function parseEuroString(value) {
  return parseFloat(value.replace(',', '.').replace('‚Ç¨', '').trim()) || 0;
}

function updateTotals() {
  const inkoopInputs = document.querySelectorAll('input[data-type="inkoop"]');
  const verkoopInputs = document.querySelectorAll('input[data-type="verkoop"]');
  const begeleidingsInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(1) input');

  let inkoopTotaal = 0;
  let verkoopTotaal = 0;

  inkoopInputs.forEach(input => {
    const bedrag = parseEuroString(input.value);
    if (!isNaN(bedrag)) inkoopTotaal += bedrag;
  });

  verkoopInputs.forEach((input, index) => {
    if (index === 0 && begeleidingsInputs[0]?.value.trim().toLowerCase() === 'bemiddeling stz') {
      verkoopTotaal += 75.00;
    } else {
      const bedrag = parseEuroString(input.value);
      if (!isNaN(bedrag)) verkoopTotaal += bedrag;
    }
  });

  const marge = verkoopTotaal - inkoopTotaal;

  document.getElementById('inkoop_totaal').value = inkoopTotaal ? `‚Ç¨ ${inkoopTotaal.toFixed(2).replace('.', ',')}` : '';
  document.getElementById('verkoop_totaal').value = verkoopTotaal ? `‚Ç¨ ${verkoopTotaal.toFixed(2).replace('.', ',')}` : '';
  document.getElementById('marge').value = marge ? `‚Ç¨ ${marge.toFixed(2).replace('.', ',')}` : '';
}

document.addEventListener('DOMContentLoaded', () => {
  const begeleidingsInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(1) input');
  const urenInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(5) input');
  const verkoopInputs = document.querySelectorAll('input[data-type="verkoop"]');
  const inkoopInputs = document.querySelectorAll('input[data-type="inkoop"]');

  // Regel 1: Bemiddeling STZ = vaste verkoopprijs 75,00
  if (begeleidingsInputs[0] && verkoopInputs[0]) {
    if (begeleidingsInputs[0].value.trim().toLowerCase() === 'bemiddeling stz') {
      verkoopInputs[0].value = '75,00';
    }
    begeleidingsInputs[0].addEventListener('input', () => {
      if (begeleidingsInputs[0].value.trim().toLowerCase() === 'bemiddeling stz') {
        verkoopInputs[0].value = '75,00';
        updateTotals();
      }
    });
  }

  // Berekening verkoopprijs via uren
  urenInputs.forEach((input, index) => {
    input.addEventListener('input', () => {
      const uren = parseFloat(input.value);
      if (!isNaN(uren)) {
        if (!(index === 0 && begeleidingsInputs[0].value.trim().toLowerCase() === 'bemiddeling stz')) {
          verkoopInputs[index].value = (uren * 62.5).toFixed(2).replace('.', ',');
        }
        updateTotals();
      }
    });
  });

  [...inkoopInputs, ...verkoopInputs].forEach(input => {
    input.addEventListener('blur', () => {
      const raw = input.value.trim();
      if (raw === '') {
        input.value = '';
        updateTotals();
        return;
      }
      const bedrag = parseEuroString(input.value);
      if (!isNaN(bedrag)) input.value = formatEuro(bedrag);
      updateTotals();
    });

    input.addEventListener('focus', () => {
      if (input.value === '0,00') input.value = '';
    });
  });

  updateTotals();
});
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
  async function genereerPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const refnummer = "2025." + (document.getElementById("referentienummer").value || "");
    const behandelaar = document.getElementById("behandelaar").value || "";
    const eindcontrole = document.getElementById("eindcontrole").value || "";
    const opdrachtgever = document.getElementById("opdrachtgever").value || "";
    const vervoerder = document.getElementById("vervoerder").value || "";
    const referentie = document.getElementById("referentie_klant").value || "";
    const omschrijving = document.getElementById("omschrijving").value || "";
    const opmerkingen = document.getElementById("opmerkingen_facturatie").value || "";
    const inkoop = document.getElementById("inkoop_totaal").value || "";
    const verkoop = document.getElementById("verkoop_totaal").value || "";
    const marge = document.getElementById("marge").value || "";

    doc.setFontSize(14);
    doc.setFont("helvetica", "bold");
    doc.text("BEGELEIDINGEN RAPPORT", 105, 15, { align: "center" });

    doc.setFontSize(11);

    const veld = (label, val, y) => {
      doc.setFont("helvetica", "bold");
      doc.text(`${label}`, 14, y);
      doc.setFont("helvetica", "normal");
      doc.text(val, 60, y);
    };

    let y = 25;
    veld("Referentienummer:", refnummer, y); y += 6;
    veld("Behandelaar:", behandelaar, y); y += 6;
    veld("Eindcontrole:", eindcontrole, y); y += 6;
    veld("Opdrachtgever:", opdrachtgever, y); y += 6;
    veld("Vervoerder:", vervoerder, y); y += 6;
    veld("Referentie klant:", referentie, y); y += 6;
    doc.setFont("helvetica", "bold");
    doc.text("Omschrijving:", 14, y); y += 6;
    doc.setFont("helvetica", "normal");
    doc.text(doc.splitTextToSize(omschrijving, 180), 14, y); y += 14;

    // Tabeldata
    const body = [];
    const kolommen = document.querySelectorAll(".form-grid-seven > div");

    for (let i = 0; i < 8; i++) {
      const rij = [];
      for (let j = 0; j < 7; j++) {
        let val = kolommen[j]?.querySelectorAll("input")[i]?.value || "";

        // Transportdatum formatteren
        if (j === 1 && val.includes("-")) {
          const [jaar, maand, dag] = val.split("-");
          val = `${dag}-${maand}-${jaar}`;
        }

        rij.push(val);
      }
      if (rij.some(v => v !== "")) {
        body.push(rij);
      }
    }

    doc.autoTable({
      startY: y,
      head: [["Firma", "Datum", "Van", "Naar", "Uren", "Inkoop (‚Ç¨)", "Verkoop (‚Ç¨)"]],
      body: body,
      styles: { fontSize: 10, cellPadding: 2 },
      theme: 'grid'
    });

    let eindY = doc.lastAutoTable.finalY + 10;
    veld("Inkoopprijs totaal:", inkoop, eindY); eindY += 6;
    veld("Verkoopprijs totaal:", verkoop, eindY); eindY += 6;
    veld("Marge:", marge, eindY); eindY += 10;

    doc.setFont("helvetica", "bold");
    doc.text("Opmerkingen t.a.v. facturatie:", 14, eindY);
    doc.setFont("helvetica", "normal");
    doc.text(doc.splitTextToSize(opmerkingen, 180), 14, eindY + 6);

    doc.save(`${refnummer || "begeleiding"}.pdf`);
  }
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyDhYR1OuoDaIFeN4-JITfyTdsleadSMTNo",
    authDomain: "vergunningenapp-8455e.firebaseapp.com",
    projectId: "vergunningenapp-8455e",
    storageBucket: "vergunningenapp-8455e.appspot.com",
    messagingSenderId: "882694266288",
    appId: "1:882694266288:web:4b1cb14817e6ba2290ca75"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let currentUser = null;
  let huidigRapportId = null;

  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      laadRapporten();
    } else {
      alert("Je bent niet ingelogd.");
      window.location.href = "index.html";
    }
  });

  window.opslaanRapport = async function () {
  const refnummer = document.querySelector("#referentienummer")?.value || "";
  const opdrachtgever = document.getElementById("opdrachtgever").value;
  const behandelaar = document.getElementById("behandelaar").value;
  const vervoerder = document.getElementById("vervoerder").value;
  const referentie_klant = document.getElementById("referentie_klant").value;
  const omschrijving = document.getElementById("omschrijving").value;
  const opmerkingen_facturatie = document.getElementById("opmerkingen_facturatie").value;
  const inkoop_totaal = (document.getElementById("inkoop_totaal").value || "").replace("‚Ç¨", "").trim().replace(",", ".");
  const verkoop_totaal = (document.getElementById("verkoop_totaal").value || "").replace("‚Ç¨", "").trim().replace(",", ".");
  const marge = (document.getElementById("marge").value || "").replace("‚Ç¨", "").trim().replace(",", ".");

  function verzamelWaarden(selector) {
    return Array.from(document.querySelectorAll(selector)).map(input => input.value);
  }

  const firma = verzamelWaarden('.form-grid-seven > div:nth-child(1) input');
  const transportdatums = verzamelWaarden('.form-grid-seven > div:nth-child(2) input');
  const van = verzamelWaarden('.form-grid-seven > div:nth-child(3) input');
  const naar = verzamelWaarden('.form-grid-seven > div:nth-child(4) input');
  const uren = verzamelWaarden('.form-grid-seven > div:nth-child(5) input');
  const inkoopprijzen = verzamelWaarden('input[data-type="inkoop"]');
  const verkoopprijzen = verzamelWaarden('input[data-type="verkoop"]');

  const docData = {
    refnummer: "2025." + refnummer,
    opdrachtgever,
    behandelaar,
    vervoerder,
    referentie_klant,
    omschrijving,
    opmerkingen_facturatie,
    inkoop_totaal,
    verkoop_totaal,
    marge,
    firma,
    transportdatums,
    van,
    naar,
    uren,
    inkoopprijzen,
    verkoopprijzen,
    timestamp: new Date(),
    user: currentUser.uid
  };

  try {
    if (huidigRapportId) {
      await setDoc(doc(db, "begeleidingen", huidigRapportId), docData);
      alert("Rapport bijgewerkt.");
      huidigRapportId = null;
    } else {
      await addDoc(collection(db, "begeleidingen"), docData);
      alert("Rapport opgeslagen.");
    }
    laadRapporten();
  } catch (err) {
    alert("Fout bij opslaan: " + err.message);
  }
};


  window.laadRapporten = async function () {
    const rapportenBody = document.getElementById("rapportTabelBody");
    rapportenBody.innerHTML = "";

    const querySnapshot = await getDocs(collection(db, "begeleidingen"));
    querySnapshot.forEach((docSnap) => {
      const data = docSnap.data();
      const rij = document.createElement("tr");
rij.innerHTML = `
  <td data-label="Referentienummer">${data.refnummer || ''}</td>
  <td data-label="Opdrachtgever">${data.opdrachtgever || ''}</td>
  <td data-label="Behandelaar">${data.behandelaar || ''}</td>
  <td>
  <button onclick="bewerkRapport('${docSnap.id}')">‚úèÔ∏è Bewerken</button>
  <button class="verwijder" onclick="verwijderRapport('${docSnap.id}')">üóëÔ∏è Verwijderen</button>
</td>

`;
rapportenBody.appendChild(rij);
    });
  };
window.verwijderRapport = async function (id) {
  if (!confirm("Weet je zeker dat je dit rapport wilt verwijderen?")) return;
  try {
    await deleteDoc(doc(db, "begeleidingen", id));
    alert("Rapport verwijderd.");
    laadRapporten();
  } catch (e) {
    alert("Fout bij verwijderen: " + e.message);
  }
};


  window.bewerkRapport = async function (id) {
  const docRef = doc(db, "begeleidingen", id);
  const docSnap = await getDoc(docRef);

  if (!docSnap.exists()) return alert("Rapport niet gevonden");

  const data = docSnap.data();

  // Basisvelden
  document.getElementById("referentienummer").value = data.refnummer?.split(".")[1] || "";
  document.getElementById("opdrachtgever").value = data.opdrachtgever || "";
  document.getElementById("behandelaar").value = data.behandelaar || "";
  document.getElementById("vervoerder").value = data.vervoerder || "";
  document.getElementById("referentie_klant").value = data.referentie_klant || "";
  document.getElementById("omschrijving").value = data.omschrijving || "";
  document.getElementById("opmerkingen_facturatie").value = data.opmerkingen_facturatie || "";
  document.getElementById("inkoop_totaal").value = data.inkoop_totaal ? `‚Ç¨ ${parseFloat(data.inkoop_totaal).toFixed(2).replace('.', ',')}` : "";
  document.getElementById("verkoop_totaal").value = data.verkoop_totaal ? `‚Ç¨ ${parseFloat(data.verkoop_totaal).toFixed(2).replace('.', ',')}` : "";
  document.getElementById("marge").value = data.marge ? `‚Ç¨ ${parseFloat(data.marge).toFixed(2).replace('.', ',')}` : "";

  // Arrayvelden invullen
  const firmaInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(1) input');
  const datumInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(2) input');
  const vanInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(3) input');
  const naarInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(4) input');
  const urenInputs = document.querySelectorAll('.form-grid-seven > div:nth-child(5) input');
  const inkoopInputs = document.querySelectorAll('input[data-type="inkoop"]');
  const verkoopInputs = document.querySelectorAll('input[data-type="verkoop"]');

  const arrays = {
    firma: data.firma || [],
    transportdatums: data.transportdatums || [],
    van: data.van || [],
    naar: data.naar || [],
    uren: data.uren || [],
    inkoopprijzen: data.inkoopprijzen || [],
    verkoopprijzen: data.verkoopprijzen || [],
  };

  arrays.firma.forEach((val, i) => firmaInputs[i] && (firmaInputs[i].value = val || ""));
  arrays.transportdatums.forEach((val, i) => datumInputs[i] && (datumInputs[i].value = val ? val.split("-").reverse().join("-") : ""));
  arrays.van.forEach((val, i) => vanInputs[i] && (vanInputs[i].value = val || ""));
  arrays.naar.forEach((val, i) => naarInputs[i] && (naarInputs[i].value = val || ""));
  arrays.uren.forEach((val, i) => urenInputs[i] && (urenInputs[i].value = val || ""));
  arrays.inkoopprijzen.forEach((val, i) => inkoopInputs[i] && (inkoopInputs[i].value = val ? val.toString().replace('.', ',') : ""));
  arrays.verkoopprijzen.forEach((val, i) => verkoopInputs[i] && (verkoopInputs[i].value = val ? val.toString().replace('.', ',') : ""));

  huidigRapportId = id;
  window.scrollTo({ top: 0, behavior: "smooth" });
};

</script>

<footer>
  ¬©2025 - Ontwikkeld door Ren√© van Bavel - VMSbeheer.nl
</footer>


</body>
</html>
